# UDP分片与重组完整案例模拟

本文档描述了如何模拟UDP报文请求发送、接收响应以及基于分片头进行数据重组的完整过程。

## 1. 场景描述

当UDP响应数据量超过网络传输单元（MTU）时，需要在应用层进行分片发送。接收端收到分片后，根据分片头信息将多个分片重组为完整数据。

## 2. 协议结构

### 2.1 分片头 (15字节)

| 序号 | 名称 | 类型 | 长度 | 说明 |
|-----|-----|-----|-----|-----|
| 1 | 会话ID | uint32_t | 4 | 标识同一个大数据块的所有包 |
| 2 | 总包数 | uint16_t | 2 | |
| 3 | 当前包序号 | uint16_t | 2 | 从0开始 |
| 4 | 当前包数据大小 | uint16_t | 2 | 数据长度 |
| 5 | 标志位 | uint8_t | 1 | 保留 |
| 6 | 校验和 | uint32_t | 4 | 保留 |

### 2.2 数据载荷

分片头之后紧跟实际的数据片段。

## 3. 模拟流程代码

完整模拟代码位于: `src/test/java/com/orca/com/protocol/EndToEndFragmentSimulationTest.java`

### 步骤概览

1. **客户端构造请求**: 创建 `UdpRequest` 并编码。
2. **服务端接收处理**: 解码请求，生成包含大量数据的 `UdpResponse`。
3. **服务端分片**: 
    - 使用 `FragmentSplitter` 将响应数据拆分为多个小于 MTU 的分片。
    - 每个分片添加分片头。
4. **网络传输**: 模拟网络环境，打乱分片到达顺序。
5. **客户端重组**:
    - 接收分片，解析分片头。
    - 使用 `FragmentReassembler` 缓存并重组分片。
    - 当收到所有分片后，合并还原完整数据。
6. **客户端解析**: 解码还原后的数据为 `UdpResponse` 对象。

## 4. 运行模拟

使用以下命令运行模拟测试：

```bash
./mvnw test -Dtest=EndToEndFragmentSimulationTest
```

输出示例：

```text
=== 开始完整UDP分片通讯模拟 ===

[客户端] 1. 构造请求...
[客户端] 请求已编码，长度: 44 字节

[服务端] 2. 接收请求并生成大数据响应...
[服务端] 响应数据生成完毕，总长度: 2412 字节

[服务端] 3. 执行数据分片 (MTU=200, Payload=185)...
[服务端] 数据已拆分为 14 个分片

[网络] 4. 模拟网络传输 (打乱分片顺序)...

[客户端] 5. 接收分片并重组...
   -> 收到分片: 会话ID=317428662, 序号=6/14, 数据大小=185
   ...
   [!] 所有分片接收完毕，重组成功！

[客户端] 6. 验证完整数据...
[客户端] 业务数据解析成功：
   - RequestID: 1001
   - Item Count: 50
```
